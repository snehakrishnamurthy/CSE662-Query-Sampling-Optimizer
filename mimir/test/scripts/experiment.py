#!/usr/bin/python

import os
import subprocess
import glob
import argparse
import time

scripts = os.path.dirname(os.path.realpath(__file__))
mimirhome = os.path.abspath(os.path.join(scripts, "..", ".."))
FNULL = open(os.devnull, 'w')

def buildmimir():

	print("\n\nBuilding mimir...")
	os.chdir("mimircore")
	try:
		subprocess.check_call(["sbt", "package"])
	except subprocess.CalledProcessError:
		print("Sbt package failed, exiting...")
		sys.exit(0)

	os.chdir("..")


if __name__ == "__main__":
	parser = argparse.ArgumentParser(description= """
		Run experiments on a given tpch database generated by tpch.py
		"""
		)

	parser.add_argument('--db', default="tpchsmall.db", help="The db to run the experiments on, this must have been set up by tpch.py")
	parser.add_argument('-t', '--timeout', default=600, help="Timeout in seconds")
	args = parser.parse_args()

	os.chdir(mimirhome)


	# MIMIR IN-DB

	try:
		print("Switching to mimir-inDB")
		subprocess.check_call(["git", "checkout", "backing-store"])
	except subprocess.CalledProcessError:
		print("Failed to checkout backing-store, exiting...")
		sys.exit(0)	


	buildmimir()


	print("\n\n\nMimir-inDB")
	
	files = glob.glob("test/tpch_queries/noagg/*.sql")
	for f in files:
		print("{0}".format(f))
		start = time.time()
		try:
			subprocess.check_call(["./bin/mimir", "--db", args.db, f], stdout=FNULL)
		except subprocess.CalledProcessError:
			print("Failed to checkout backing-store, exiting...")
			sys.exit(0)	

		print("Time: {0}s\n".format(time.time() - start))


	print("\n\n\nDeterministic queries")

	files = glob.glob("test/tpch_queries/det/*.sql")
	for f in files:
		print("{0}".format(f))
		start = time.time()

		try:
			subprocess.check_call(["./bin/mimir", "--db", args.db, f], stdout=FNULL)
		except subprocess.CalledProcessError:
			print("Timed out...")
			sys.exit(0)	
		print("Time: {0}s\n".format(time.time() - start))

	


	# MIMIR CLASSIC

	try:
		print("Switching to mimir-classic")
		subprocess.check_call(["git", "checkout", "mimir-classic"])
	except subprocess.CalledProcessError:
		print("Failed to checkout backing-store, exiting...")
		sys.exit(0)	

	buildmimir()


	print("\n\n\nMimir-classic")

	files = glob.glob("test/tpch_queries/noagg/*.sql")
	for f in files:
		print("{0}".format(f))
		start = time.time()
		try:
			subprocess.check_call(["./bin/mimir", "--db", args.db, f], stdout=FNULL)
		except subprocess.CalledProcessError:
			print("Timed out...")
			sys.exit(0)	
		print("Time: {0}s\n".format(time.time() - start))


	print("Done. Switching back to backing-store branch...")
	subprocess.check_call(["git", "checkout", "backing-store"])
